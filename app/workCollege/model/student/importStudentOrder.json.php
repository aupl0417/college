<?php
/*=============================================================================
#     FileName: importStudentOrder.json.php
#         Desc: 导入学员报名订单
#       Author: Wuyuanhang
#        Email: QQ:554119220
#   LastChange: 2016-10-27 08:47:34
#      History:
#      Paramer:
=============================================================================*/

class importStudentOrder_json extends worker {
    function __construct($options) {
        parent::__construct($options, '50020101');
    }

    function run() {
        $mobile = array(
'18028765439',
'18316996019',
'13826535731',
'18823329918',
'13538222194',
'18004494499',
'13662666062',
'13923802753',
'18183738852',
'15260888687',
'13823558630',
'13538012677',
'13504325806',
'13134303105',
'13159562977',
'13069249957',
'13154300112',
'13164200086',
'13596480301',
'13336060828',
'15168409816',
'18658898958',
'18966497707',
'18058105113',
'15005102652',
'13705712233',
'15968319222',
'17708627941',
'13702444044',
'13794619333',
'13922743988',
'15099998219',
'13824479088',
'13738550888',
'13606660833',
'15968319222',
'18018237021',
'18018237021',
'13305529512',
'15305518689',
'18627310315',
'18673116826',
'13571628816',
'18855325972',
'13506719132',
'18969130950',
'13206461133',
'15277290783',
'18158413269',
'18232377775',
'15076071818',
'13929578577',
'13734888435',
'13633922355',
'18574515337',
'18577517570',
'13807531266',
'13976285558',
'15383835811',
'15033411104',
'13933815666',
'15080635134',
'13336164123',
'13816108568',
'13858477888',
'13640231794',
'18074811166',
'18277127717',
'13647719359',
'13407745962',
'13977109062',
'18777178993',
'13607815949',
'15278069950',
'15077000320',
'13677888998',
'13587885852',
'18778050551',
'18007712303',
'13321705313',
'13517718181',
'13732006621',
'13587679856',
'15177777298',
'15957705319',
'13459552041',
'18631171726',
'13924209199',
'13926243908',
'13989802632',
'18969130950',
'18657181582',
'18258138088',
'18270850429',
'13867432207',
'18657181525',
'18958101608',
'13199560068',
'18697918313',
'18826067645',
'15728479555',
'18664660798',
'18883333388',
'13349394313',
'18973189888',
'18983771654',
'15566661299',
'15578968664',
'18269019055',
'18978935053',
'13878003888',
'13878295830',
'15977295866',
'18628873335',
'18628872226',
'15983206095',
'13708447888',
'15368855288',
'15912036153',
'13085389930',
'18601015366',
'18610212345',
'18611862666',
'13587739168',
'13708136963',
'18523111419',
'18909056909',
'13318793025',
'13430251804',
'13355779973',
'13558935858',
'15390370668',
'18577188877',
'13608886096',
'15099902049',
'15177777281',
'17710053113',
'13705271687',
'18230326666',
'18246923999',
'13968888275',
'15858561818',
'13665230009',
'18670054271',
'18671802111',
'15900636271',
'15573170812',
'18973129036',
'13755199670',
'18684684728',
'13923861138',
'18074604290',
'15200862859',
'18874868866',
'18673654189',
'18673637827',
'13306136878',
'13278973777',
'18273227775',
'13054155885',
'18374154079',
'13874638959',
'15367461663',
'18883333388',
'15707466789',
'13787680606',
'13922418599',
'15116689968',
'18674645791',
'13702444044',
'13257466982',
'13243609786',
'17502406088',
'15807487402',
'13410414720',
'15211143322',
'13087880081',
'15336425858',
'13977109062',


        );

        $now = F::mytime();
        $data = array(
            'tse_id'           => $options['orderId'],
            'tse_userId'       => $options['uid'],
            'tse_userTrueName' => $userInfo['trueName'],
            'tse_certNum'      => $userInfo['certNum'],
            'tse_classId'      => 24,
            'tse_fee'          => 0,
            'tse_status'       => 2,
            'tse_state'        => 1,
            'tse_payFee'       => 0,
            'tse_eTime'        => $now,
            'tse_checkInTime'  => $now,
            'tse_createTime'   => $now,
        );

        $db = new MySql();
        $mobieList = implode("','",$mobile);

        $userList = $db->getAll("SELECT id,userId,trueName,certNum FROM tang_ucenter_member WHERE mobile IN('{$mobieList}')");

        foreach ($userList as $k=>$v) {
            $error = [];
            $isExist = [];

            $orderId = F::getTimeMarkID();
            $data['tse_id'] = $orderId;
            $data['tse_orderId'] = $orderId;
            $data['tse_userId'] = $v['id'];
            $data['tse_userTrueName'] = $v['trueName'];
            $data['tse_certNum'] = $v['certNum'];

            if ($db->count('tang_student_enroll',"tse_userId='{$v['id']}' AND tse_classId=24")) {
                $isExist[] = $data;
                continue;
            }
            $res = $db->insert('tang_student_enroll',$data);
            if (1 != $res) {
                $error[] = $data;
            }
        }

        if (count($error)>0) {
            die($this->show(message::getJsonMsgStruct('1002',array('error'=>$error,'isExist'=>$isExist))));
        }

        $this->show(message::getJsonMsgStruct('1001',array('res'=>'导入成功','isExist'=>$isExist)));
    }
}
